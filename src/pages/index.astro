---
import { getCollection } from 'astro:content';
import Page from '../layouts/Page.astro';
import Layout from '../components/Layout.astro';
import Hero from '../components/Hero.astro';
import About from '../components/About.astro';
import Experience from '../components/Experience.astro';
import Projects from '../components/Projects.astro';
import Contact from '../components/Contact.astro';

// Get all content
const personalEntries = await getCollection('personal');
const experienceEntries = await getCollection('experiences');
const projectEntries = await getCollection('projects');
const skillEntries = await getCollection('skills');
const postEntries = await getCollection('posts');

// Get first (and only) personal entry
const personalEntry = personalEntries[0];
const personal = personalEntry?.data || {
  name: 'Lorem Ipsum',
  title: 'Full Stack Developer',
  bio: 'Lorem ipsum dolor sit amet...',
};

// Render markdown content for bio
const { Content: BioContent } = personalEntry ? await personalEntry.render() : { Content: null };

// Sort experiences by start date (newest first)
const experiences = experienceEntries
  .map(entry => entry.data)
  .sort((a, b) => {
    const dateA = new Date(a.startDate).getTime();
    const dateB = new Date(b.startDate).getTime();
    return dateB - dateA;
  });

// Get all projects
const projects = projectEntries.map(entry => entry.data);

// Group skills by category
const skills = skillEntries.map(entry => entry.data);

// Get recent posts (sorted by date, newest first, limit to 3)
const posts = postEntries
  .map(entry => entry.data)
  .sort((a, b) => {
    const dateA = new Date(a.date).getTime();
    const dateB = new Date(b.date).getTime();
    return dateB - dateA;
  })
  .slice(0, 3);

const siteUrl = 'https://yourusername.github.io/my-portfolio';
const pageTitle = `${personal.name} - ${personal.title}`;
const pageDescription = personal.bio || personalEntry?.body || 'Personal portfolio website';
---

<Page
  title={pageTitle}
  description={pageDescription}
  canonicalURL={siteUrl}
  personalData={personal}
  siteUrl={siteUrl}
>
  <Layout title={personal.name}>
    <Hero
      name={personal.name}
      title={personal.title}
      bio={personal.bio}
      BioContent={BioContent}
      avatar={personal.avatar}
      university={personal.university}
      email={personal.email}
      linkedin={personal.linkedin}
      github={personal.github}
      twitter={personal.twitter}
      scholar={personal.scholar}
      cv={personal.cv}
      huggingface={personal.huggingface}
      medium={personal.medium}
      interests={personal.interests}
      posts={posts}
    />
    <About
      bio={personal.bio}
      BioContent={BioContent}
      location={personal.location}
      skills={skills}
    />
    <Experience experiences={experiences} />
    <Projects projects={projects} />
    <Contact
      email={personal.email}
      website={personal.website}
      github={personal.github}
      linkedin={personal.linkedin}
      twitter={personal.twitter}
      huggingface={personal.huggingface}
      medium={personal.medium}
    />
  </Layout>
</Page>
